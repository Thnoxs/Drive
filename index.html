<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <link rel="shortcut icon" href="assets/logo.png" type="image/x-icon" />
    <title>Drive Player | Telegram Theme</title>

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
      :root {
        --tg-bg-main: #0e1621;
        --tg-bg-sidebar: #17212b;
        --tg-item-hover: #202b36;
        --tg-active: #2b5278;
        --tg-text: #ffffff;
        --tg-text-muted: #7f91a4;
        --tg-blue: #5288c1;
        --tg-green: #46a758;
      }

      body {
        background-color: var(--tg-bg-main);
        color: var(--tg-text);
        font-family: "Roboto", sans-serif;
        overflow: hidden;
      }

      /* Wave Animation Style */
      .wave-container {
        display: flex;
        align-items: flex-end;
        gap: 2px;
        height: 12px;
      }
      .wave-bar {
        width: 3px;
        background: white;
        animation: wave-anim 0.8s infinite ease-in-out;
      }
      .wave-bar:nth-child(2) {
        animation-delay: 0.2s;
      }
      .wave-bar:nth-child(3) {
        animation-delay: 0.4s;
      }
      @keyframes wave-anim {
        0%,
        100% {
          height: 4px;
        }
        50% {
          height: 12px;
        }
      }

      .tg-sidebar {
        background-color: var(--tg-bg-sidebar);
        border-right: 1px solid #000;
      }
      .tg-item {
        padding: 10px 15px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 12px;
        border-bottom: 1px solid #0e1621;
      }
      .tg-item:hover {
        background-color: var(--tg-item-hover);
      }
      .tg-item.active {
        background-color: var(--tg-active);
      }

      .progress-mini {
        height: 2px;
        background: #242f3d;
        width: 100%;
        margin-top: 4px;
        border-radius: 2px;
        overflow: hidden;
      }
      .progress-inner {
        height: 100%;
        background: var(--tg-blue);
        width: 0%;
        transition: width 0.3s;
      }

      .avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }
      .avatar-blue {
        background: #5288c1;
      }
      .avatar-green {
        background: #46a758;
      }

      .video-js .vjs-big-play-button {
        border-radius: 50%;
        width: 70px;
        height: 70px;
        line-height: 65px;
        top: 50%;
        left: 50%;
        margin-top: -35px;
        margin-left: -35px;
      }

      @media (max-width: 768px) {
        #sidebar {
          position: absolute;
          height: 100%;
          z-index: 50;
          transform: translateX(-100%);
          width: 85%;
        }
        #sidebar.open {
          transform: translateX(0);
        }
        .overlay {
          display: none;
          position: absolute;
          inset: 0;
          background: rgba(0, 0, 0, 0.6);
          z-index: 40;
        }
        .overlay.show {
          display: block;
        }
      }
    </style>
  </head>
  <body class="h-screen flex flex-col md:flex-row">
    <div
      id="library-screen"
      class="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-[#0e1621]"
    >
      <div class="w-full max-w-2xl p-4">
        <div class="text-center mb-8">
          <h1 class="text-2xl font-bold">Drive Player</h1>
          <p class="text-muted">Enter folder details</p>
        </div>
        <div class="bg-[#17212b] p-4 rounded-xl flex gap-2 mb-6">
          <input
            type="text"
            id="new-course-name"
            placeholder="Course Name"
            class="bg-[#242f3d] p-3 rounded-lg w-1/3 outline-none text-white"
          />
          <input
            type="text"
            id="new-course-link"
            placeholder="Drive Folder Link"
            class="bg-[#242f3d] p-3 rounded-lg w-full outline-none text-white"
          />
          <button onclick="addCourse()" class="bg-[#5288c1] px-6 rounded-lg">
            <i class="fa-solid fa-plus"></i>
          </button>
        </div>
        <div
          id="course-list"
          class="flex flex-col gap-2 max-h-[50vh] overflow-y-auto"
        ></div>
        <button
          onclick="closeLibrary()"
          id="close-lib-btn"
          class="mt-4 text-muted hidden w-full"
        >
          Back to Player
        </button>
      </div>
    </div>

    <div class="flex-1 flex relative w-full h-full">
      <div id="sidebar-overlay" class="overlay" onclick="toggleSidebar()"></div>

      <aside
        id="sidebar"
        class="w-[350px] tg-sidebar flex flex-col shrink-0 h-full"
      >
        <div
          class="h-[60px] flex items-center px-4 bg-[#17212b] shrink-0 gap-3"
        >
          <button onclick="showLibrary()" class="text-muted hover:text-white">
            <i class="fa-solid fa-arrow-left"></i>
          </button>
          <div class="flex-1 min-w-0">
            <h2 id="header-course-name" class="font-medium truncate">
              Select Course
            </h2>
          </div>
        </div>
        <div class="px-3 py-2">
          <input
            type="text"
            id="search"
            placeholder="Search videos..."
            class="w-full bg-[#242f3d] rounded-full px-4 py-2 text-sm outline-none text-white"
          />
        </div>
        <div id="playlist" class="flex-1 overflow-y-auto"></div>
      </aside>

      <main class="flex-1 flex flex-col bg-black">
        <div
          class="md:hidden h-[56px] bg-[#17212b] flex items-center px-4 gap-4"
          onclick="toggleSidebar()"
        >
          <i class="fa-solid fa-bars text-muted"></i>
          <span id="mobile-title" class="truncate text-sm">Drive Player</span>
        </div>
        <div class="flex-1 flex items-center justify-center relative">
          <video
            id="my-video"
            class="video-js vjs-fill vjs-big-play-centered"
            controls
            preload="auto"
            playsinline
          ></video>
        </div>
        <div
          class="h-[70px] bg-[#17212b] flex items-center justify-between px-6 border-t border-black"
        >
          <div id="footer-title" class="text-sm font-medium truncate w-1/3">
            No video selected
          </div>
          <div class="flex items-center gap-5">
            <button onclick="playPrev()" class="text-muted hover:text-white">
              <i class="fa-solid fa-backward-step fa-xl"></i>
            </button>
            <button
              onclick="togglePlay()"
              class="w-12 h-12 rounded-full bg-[#5288c1] flex items-center justify-center shadow-lg"
            >
              <i id="play-pause-icon" class="fa-solid fa-play ml-1"></i>
            </button>
            <button onclick="playNext()" class="text-muted hover:text-white">
              <i class="fa-solid fa-forward-step fa-xl"></i>
            </button>
          </div>
          <div class="w-1/3 flex justify-end">
            <button
              onclick="toggleFullscreen()"
              class="text-muted hover:text-white"
            >
              <i class="fa-solid fa-expand"></i>
            </button>
          </div>
        </div>
      </main>
    </div>

    <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
    <script>
      const BACKEND_URL = "https://drive-2ipw.onrender.com";
      let savedCourses = JSON.parse(
        localStorage.getItem("drive_courses") || "[]",
      );
      let completedVideos = JSON.parse(
        localStorage.getItem("completed_videos") || "[]",
      );
      let currentCourse = null,
        flatPlaylist = [],
        currentIndex = -1;

      const player = videojs("my-video");

      // --- 1. KEYBOARD SHORTCUTS ---
      document.addEventListener("keydown", (e) => {
        if (e.target.tagName === "INPUT") return;
        const k = e.key.toLowerCase();

        if (e.code === "Space") {
          e.preventDefault();
          togglePlay();
        }
        if (k === "f") toggleFullscreen();
        if (k === "arrowright") player.currentTime(player.currentTime() + 10);
        if (k === "arrowleft") player.currentTime(player.currentTime() - 10);
        if (k === "arrowup") {
          e.preventDefault();
          player.volume(Math.min(player.volume() + 0.1, 1));
        }
        if (k === "arrowdown") {
          e.preventDefault();
          player.volume(Math.max(player.volume() - 0.1, 0));
        }
        if (k === "n") playNext();
        if (k === "p") playPrev();
      });

      // --- 2. PROGRESS & COMPLETION LOGIC ---
      player.on("timeupdate", () => {
        if (currentIndex === -1) return;
        const vidId = flatPlaylist[currentIndex].id;
        const percent = (player.currentTime() / player.duration()) * 100;

        // Update Mini Progress Bar in Sidebar
        const bar = document.querySelector(`#vid-${vidId} .progress-inner`);
        if (bar) bar.style.width = percent + "%";

        // Mark as Finished (if > 90%)
        if (percent > 90 && !completedVideos.includes(vidId)) {
          completedVideos.push(vidId);
          localStorage.setItem(
            "completed_videos",
            JSON.stringify(completedVideos),
          );
          updateStatusIcon(vidId, true);
        }
      });

      function updateStatusIcon(vidId, isDone) {
        const iconBox = document.querySelector(`#vid-${vidId} .icon-box`);
        if (!iconBox) return;
        if (isDone) {
          iconBox.innerHTML = `<i class="fa-solid fa-check text-xs text-white"></i>`;
          iconBox.classList.add("bg-green-500");
          iconBox.classList.remove("bg-[#242f3d]");
        }
      }

      // --- 3. UI RENDERING ---
      async function loadCourse(courseObj, videoId = null) {
        currentCourse = courseObj;
        document.getElementById("library-screen").classList.add("hidden");
        document.getElementById("header-course-name").innerText =
          courseObj.name;

        const container = document.getElementById("playlist");
        container.innerHTML = `<div class="p-5 text-center text-muted">Loading Playlist...</div>`;
        flatPlaylist = [];
        await fetchCourseContent(courseObj.id, container);
        finalizeUI();
        if (videoId) playVideoById(videoId);
      }

      async function fetchCourseContent(rootId, container) {
        try {
          const res = await fetch(`${BACKEND_URL}/api/list/${rootId}`);
          const data = await res.json();
          container.innerHTML = "";

          // Filter videos and show them
          const videos = data.files.filter((f) => f.mimeType.includes("video"));
          videos.forEach((v) => {
            flatPlaylist.push(v);
            const isDone = completedVideos.includes(v.id);
            const div = document.createElement("div");
            div.id = `vid-${v.id}`;
            div.className = "tg-item file-btn group";
            div.innerHTML = `
                    <div class="w-10 h-10 rounded-full flex items-center justify-center shrink-0 icon-box ${isDone ? "bg-green-500" : "bg-[#242f3d]"}">
                        ${isDone ? '<i class="fa-solid fa-check text-xs text-white"></i>' : '<i class="fa-solid fa-play text-xs text-[#5288c1]"></i>'}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="text-sm font-medium truncate">${v.name.replace(/\.[^/.]+$/, "")}</div>
                        <div class="progress-mini"><div class="progress-inner"></div></div>
                    </div>
                `;
            div.onclick = () => playVideoById(v.id);
            container.appendChild(div);
          });
        } catch (e) {
          container.innerHTML = "Error loading files.";
        }
      }

      function playVideoById(id) {
        const idx = flatPlaylist.findIndex((x) => x.id === id);
        if (idx === -1) return;
        currentIndex = idx;
        const v = flatPlaylist[idx];

        player.src({ type: "video/mp4", src: `${BACKEND_URL}/stream/${v.id}` });
        player.play();

        // UI Updates
        document.getElementById("footer-title").innerText = v.name;
        document.getElementById("mobile-title").innerText = v.name;

        // Remove active & Reset others
        document.querySelectorAll(".tg-item").forEach((el) => {
          el.classList.remove("active");
          const box = el.querySelector(".icon-box");
          const vid = el.id.replace("vid-", "");
          if (!completedVideos.includes(vid)) {
            box.innerHTML = `<i class="fa-solid fa-play text-xs text-[#5288c1]"></i>`;
            box.className =
              "w-10 h-10 rounded-full flex items-center justify-center shrink-0 icon-box bg-[#242f3d]";
          }
        });

        // Set Active & Add Wave Animation
        const activeItem = document.getElementById(`vid-${id}`);
        if (activeItem) {
          activeItem.classList.add("active");
          const box = activeItem.querySelector(".icon-box");
          box.innerHTML = `<div class="wave-container"><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div></div>`;
          box.className =
            "w-10 h-10 rounded-full flex items-center justify-center shrink-0 icon-box bg-[#5288c1]";
          activeItem.scrollIntoView({ behavior: "smooth", block: "center" });
        }
      }

      // --- HELPER FUNCTIONS ---
      function togglePlay() {
        player.paused() ? player.play() : player.pause();
      }
      function playNext() {
        if (currentIndex < flatPlaylist.length - 1)
          playVideoById(flatPlaylist[currentIndex + 1].id);
      }
      function playPrev() {
        if (currentIndex > 0) playVideoById(flatPlaylist[currentIndex - 1].id);
      }
      function toggleFullscreen() {
        player.isFullscreen()
          ? player.exitFullscreen()
          : player.requestFullscreen();
      }
      function toggleSidebar() {
        document.getElementById("sidebar").classList.toggle("open");
        document.getElementById("sidebar-overlay").classList.toggle("show");
      }
      function showLibrary() {
        document.getElementById("library-screen").classList.remove("hidden");
        renderLibrary();
      }
      function closeLibrary() {
        if (currentCourse)
          document.getElementById("library-screen").classList.add("hidden");
      }

      function addCourse() {
        const name = document.getElementById("new-course-name").value;
        const link = document.getElementById("new-course-link").value;
        const idMatch = link.match(/[-\w]{25,}/);
        if (name && idMatch) {
          savedCourses.push({ name, id: idMatch[0] });
          localStorage.setItem("drive_courses", JSON.stringify(savedCourses));
          renderLibrary();
        }
      }

      function renderLibrary() {
        const list = document.getElementById("course-list");
        list.innerHTML = "";
        savedCourses.forEach((c, i) => {
          const div = document.createElement("div");
          div.className =
            "bg-[#17212b] p-4 rounded-lg flex justify-between items-center cursor-pointer";
          div.innerHTML = `<span>${c.name}</span><button onclick="deleteCourse(${i})" class="text-red-400"><i class="fa-solid fa-trash"></i></button>`;
          div.onclick = (e) => {
            if (e.target.tagName !== "I" && e.target.tagName !== "BUTTON")
              loadCourse(c);
          };
          list.appendChild(div);
        });
      }

      function deleteCourse(i) {
        savedCourses.splice(i, 1);
        localStorage.setItem("drive_courses", JSON.stringify(savedCourses));
        renderLibrary();
      }

      player.on(
        "play",
        () =>
          (document.getElementById("play-pause-icon").className =
            "fa-solid fa-pause"),
      );
      player.on(
        "pause",
        () =>
          (document.getElementById("play-pause-icon").className =
            "fa-solid fa-play"),
      );
      player.on("ended", playNext);

      renderLibrary();
    </script>
  </body>
</html>
