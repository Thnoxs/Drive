<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <link rel="shortcut icon" href="assets/logo.png" type="image/x-icon" />
    <title>Drive Player | Telegram Theme</title>

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
      /* --- TELEGRAM DARK PALETTE --- */
      :root {
        --tg-bg-main: #0e1621; /* Main Chat Area */
        --tg-bg-sidebar: #17212b; /* Sidebar */
        --tg-item-hover: #202b36; /* Hover State */
        --tg-active: #2b5278; /* Active State (Blue) */
        --tg-text: #ffffff;
        --tg-text-muted: #7f91a4; /* Timestamp/Meta color */
        --tg-border: #0e1621; /* Separators */
        --tg-blue: #5288c1; /* Accent Links/Icons */
      }

      body {
        background-color: var(--tg-bg-main);
        color: var(--tg-text);
        font-family: "Roboto", sans-serif;
        overflow: hidden;
      }

      /* --- SCROLLBAR (Telegram Style: Thin & Dark) --- */
      ::-webkit-scrollbar {
        width: 5px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 10px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: rgba(0, 0, 0, 0.4);
      }

      /* --- SIDEBAR STYLING --- */
      .tg-sidebar {
        background-color: var(--tg-bg-sidebar);
        border-right: 1px solid #000;
      }

      .tg-item {
        padding: 10px 15px;
        transition: background-color 0.1s ease;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .tg-item:hover {
        background-color: var(--tg-item-hover);
      }

      .tg-item.active {
        background-color: var(--tg-active);
      }
      .tg-item.active .text-muted {
        color: #dce3ea;
      } /* Lighter text on active */
      .tg-item.active i {
        color: #fff;
      }

      /* Avatar Circle Logic */
      .avatar {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 16px;
        flex-shrink: 0;
      }
      /* Colors for folders to look like Contact Avatars */
      .avatar-blue {
        background: #5288c1;
        color: white;
      }
      .avatar-green {
        background: #46a758;
        color: white;
      }
      .avatar-purple {
        background: #8e85ee;
        color: white;
      }

      /* --- VIDEO PLAYER OVERRIDES --- */
      .video-js .vjs-big-play-button {
        background-color: rgba(0, 0, 0, 0.5);
        border: 3px solid #fff;
        border-radius: 50%;
        width: 70px;
        height: 70px;
        line-height: 65px;
        font-size: 30px;
        margin-left: -35px;
        top: 50%;
        margin-top: -35px;
        backdrop-filter: blur(4px);
      }
      .video-js .vjs-control-bar {
        background: rgba(23, 33, 43, 0.9);
      }
      .video-js .vjs-play-progress {
        background-color: var(--tg-blue);
      }

      /* --- UTILS --- */
      .text-muted {
        color: var(--tg-text-muted);
      }

      /* --- RESPONSIVE DRAWER --- */
      #sidebar {
        transition: transform 0.25s ease-in-out;
      }
      @media (max-width: 768px) {
        #sidebar {
          position: absolute;
          height: 100%;
          z-index: 50;
          transform: translateX(-100%);
          width: 80%;
          box-shadow: 5px 0 20px rgba(0, 0, 0, 0.5);
        }
        #sidebar.open {
          transform: translateX(0);
        }
        .overlay {
          display: none;
          position: absolute;
          inset: 0;
          background: rgba(0, 0, 0, 0.6);
          z-index: 40;
        }
        .overlay.show {
          display: block;
        }
      }
    </style>
  </head>
  <body class="h-screen flex flex-col md:flex-row">
    <div
      id="toast-container"
      class="fixed bottom-16 left-1/2 transform -translate-x-1/2 z-[9999] flex flex-col gap-2 pointer-events-none"
    ></div>

    <div
      id="library-screen"
      class="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-[#0e1621]"
    >
      <div class="w-full max-w-2xl p-4 flex flex-col h-full md:h-auto">
        <div class="text-center mb-8">
          <div
            class="w-20 h-20 bg-[#5288c1] rounded-full mx-auto flex items-center justify-center mb-4 text-3xl shadow-lg"
          >
            <i class="fa-brands fa-google-drive text-white"></i>
          </div>
          <h1 class="text-2xl font-medium text-white">Drive Player</h1>
          <p class="text-[#7f91a4] text-sm mt-1">
            Paste a folder link to start watching
          </p>
        </div>

        <div class="bg-[#17212b] p-4 rounded-xl shadow-lg flex gap-2 mb-6">
          <input
            type="text"
            id="new-course-name"
            placeholder="Name"
            class="bg-[#242f3d] px-4 py-3 text-white outline-none rounded-lg w-1/3 focus:ring-1 ring-[#5288c1]"
          />
          <input
            type="text"
            id="new-course-link"
            placeholder="Google Drive Link..."
            class="bg-[#242f3d] px-4 py-3 text-white outline-none rounded-lg w-full focus:ring-1 ring-[#5288c1]"
          />
          <button
            onclick="addCourse()"
            class="bg-[#5288c1] hover:bg-[#4377ae] text-white px-5 rounded-lg font-medium transition"
          >
            <i class="fa-solid fa-arrow-right"></i>
          </button>
        </div>

        <div
          id="course-list"
          class="flex flex-col gap-2 overflow-y-auto max-h-[50vh]"
        ></div>

        <button
          onclick="closeLibrary()"
          id="close-lib-btn"
          class="mt-4 text-[#7f91a4] hover:text-white text-sm hidden"
        >
          Return to Player
        </button>
      </div>
    </div>

    <div class="flex-1 flex relative w-full h-full">
      <div id="sidebar-overlay" class="overlay" onclick="toggleSidebar()"></div>

      <aside
        id="sidebar"
        class="w-[350px] tg-sidebar flex flex-col shrink-0 h-full"
      >
        <div
          class="h-[60px] flex items-center px-4 bg-[#17212b] shrink-0 gap-4"
        >
          <button
            onclick="showLibrary()"
            class="text-[#7f91a4] hover:text-white"
          >
            <i class="fa-solid fa-arrow-left"></i>
          </button>
          <div class="flex-1">
            <h2
              id="header-course-name"
              class="font-medium text-white truncate text-base"
            >
              Select Course
            </h2>
            <p class="text-xs text-[#7f91a4]">Online</p>
          </div>
          <button onclick="toggleSidebar()" class="md:hidden text-[#7f91a4]">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>

        <div class="px-3 py-2">
          <div class="bg-[#242f3d] rounded-full flex items-center px-4 py-2">
            <i class="fa-solid fa-magnifying-glass text-[#7f91a4] text-sm"></i>
            <input
              type="text"
              id="search"
              placeholder="Search"
              class="bg-transparent border-none outline-none text-white text-sm ml-3 w-full placeholder-[#7f91a4]"
            />
          </div>
        </div>

        <div id="playlist" class="flex-1 overflow-y-auto custom-scroll"></div>
      </aside>

      <main class="flex-1 flex flex-col relative bg-[#0e1621] min-w-0">
        <div
          class="md:hidden h-[56px] bg-[#17212b] flex items-center px-4 shadow-md z-30 justify-between"
        >
          <div
            class="flex items-center gap-4 cursor-pointer"
            onclick="toggleSidebar()"
          >
            <i class="fa-solid fa-bars text-[#7f91a4] text-lg"></i>
            <div>
              <h3
                class="font-medium text-white text-sm truncate max-w-[200px]"
                id="mobile-title"
              >
                Drive Player
              </h3>
              <p class="text-[10px] text-[#5288c1]">Tap for menu</p>
            </div>
          </div>
        </div>

        <div class="flex-1 flex items-center justify-center bg-black relative">
          <video
            id="my-video"
            class="video-js vjs-fill vjs-big-play-centered"
            controls
            preload="auto"
            playsinline
          >
            <p class="vjs-no-js">Enable JS.</p>
          </video>
        </div>

        <div
          class="h-[60px] bg-[#17212b] hidden md:flex items-center justify-between px-6 border-t border-[#0e1621]"
        >
          <div
            class="text-sm text-white font-medium truncate w-1/3"
            id="footer-title"
          >
            Ready to play
          </div>
          <div class="flex items-center gap-6">
            <button
              onclick="playPrev()"
              class="text-[#7f91a4] hover:text-[#5288c1] transition"
            >
              <i class="fa-solid fa-backward-step fa-lg"></i>
            </button>
            <button
              onclick="togglePlay()"
              class="w-10 h-10 rounded-full bg-[#5288c1] text-white flex items-center justify-center hover:bg-[#4377ae] shadow-lg transition"
            >
              <i id="play-pause-icon" class="fa-solid fa-play ml-1"></i>
            </button>
            <button
              onclick="playNext()"
              class="text-[#7f91a4] hover:text-[#5288c1] transition"
            >
              <i class="fa-solid fa-forward-step fa-lg"></i>
            </button>
          </div>
          <div class="w-1/3 flex justify-end">
            <button
              onclick="toggleFullscreen()"
              class="text-[#7f91a4] hover:text-white"
            >
              <i class="fa-solid fa-expand"></i>
            </button>
          </div>
        </div>
      </main>
    </div>

    <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
    <script>
      // CONFIG
      const BACKEND_URL = "https://drive-2ipw.onrender.com";
      const CACHE_PREFIX = "drive_tg_v1_";
      const LAST_STATE_KEY = "drive_last_tg";

      let savedCourses = JSON.parse(
        localStorage.getItem("drive_courses") || "[]",
      );
      let currentCourse = null;
      let flatPlaylist = [];
      let currentIndex = -1;

      const player = videojs("my-video", {
        fill: true,
        responsive: true,
        html5: { vhs: { overrideNative: true } },
      });

      async function init() {
        // Check for shared link
        const urlParams = new URLSearchParams(window.location.search);
        const sharedCourseId = urlParams.get("c");
        const sharedVideoId = urlParams.get("v");

        if (sharedCourseId) {
          await loadSharedCourse(sharedCourseId, sharedVideoId);
        } else {
          renderLibrary();
          const lastState = JSON.parse(localStorage.getItem(LAST_STATE_KEY));
          if (savedCourses.length > 0) {
            if (lastState && lastState.courseId) {
              const c = savedCourses.find((x) => x.id === lastState.courseId);
              if (c) loadCourse(c, lastState.videoId);
            }
          }
        }
      }

      function renderLibrary() {
        const list = document.getElementById("course-list");
        list.innerHTML = "";
        savedCourses.forEach((c, i) => {
          const div = document.createElement("div");
          div.className =
            "bg-[#17212b] p-3 rounded-lg flex items-center justify-between cursor-pointer hover:bg-[#202b36] transition group";
          div.onclick = (e) => {
            if (!e.target.closest("button")) loadCourse(c);
          };
          div.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="avatar avatar-blue">${c.name[0].toUpperCase()}</div>
                    <div>
                        <div class="text-white font-medium text-sm line-clamp-1">${c.name}</div>
                        <div class="text-[#7f91a4] text-xs">Tap to resume</div>
                    </div>
                </div>
                <button onclick="deleteCourse(${i})" class="text-[#7f91a4] hover:text-red-400 opacity-0 group-hover:opacity-100 px-2"><i class="fa-solid fa-trash"></i></button>
            `;
          list.appendChild(div);
        });
      }

      async function loadCourse(courseObj, videoId = null) {
        currentCourse = courseObj;
        document.getElementById("library-screen").classList.add("hidden");
        document.getElementById("close-lib-btn").classList.remove("hidden");
        document.getElementById("header-course-name").innerText =
          courseObj.name;

        const container = document.getElementById("playlist");
        const cached = localStorage.getItem(CACHE_PREFIX + courseObj.id);

        if (cached) {
          const data = JSON.parse(cached);
          flatPlaylist = data.flatPlaylist;
          container.innerHTML = data.htmlStr;
          finalizeLoad(videoId);
        } else {
          container.innerHTML = `<div class="p-5 text-center text-[#7f91a4] text-sm">Updating...</div>`;
          flatPlaylist = [];
          await fetchCourseContent(courseObj.id, container);
          finalizeLoad(videoId);
        }
      }

      async function fetchCourseContent(rootId, container) {
        try {
          const res = await fetch(`${BACKEND_URL}/api/list/${rootId}`);
          if (!res.ok) throw new Error("Net Err");
          const data = await res.json();
          if (!data.files) return;
          container.innerHTML = "";
          const folders = data.files.filter((f) =>
            f.mimeType.includes("folder"),
          );
          const videos = data.files.filter((f) => f.mimeType.includes("video"));
          await processNodes(folders, videos, container, rootId);
          localStorage.setItem(
            CACHE_PREFIX + rootId,
            JSON.stringify({ flatPlaylist, htmlStr: container.innerHTML }),
          );
        } catch (e) {
          container.innerHTML = `<div class="text-red-400 p-4 text-center text-xs">Connection Error</div>`;
        }
      }

      async function processNodes(folders, videos, container, parentId) {
        // Folders as "Groups"
        for (const f of folders) {
          const div = document.createElement("div");
          div.innerHTML = `
                <div id="btn-${f.id}" class="tg-item group" data-id="${f.id}">
                    <div class="avatar avatar-green w-8 h-8 text-xs"><i class="fa-solid fa-folder"></i></div>
                    <div class="flex-1 min-w-0">
                        <div class="text-sm font-medium text-white truncate">${f.name}</div>
                        <div class="text-xs text-muted truncate">Folder</div>
                    </div>
                    <i class="fa-solid fa-chevron-down text-xs text-muted opacity-50 chevron"></i>
                </div>
                <div id="folder-${f.id}" class="hidden pl-2 bg-[#0e1621] border-l-2 border-[#17212b]"></div>
            `;
          container.appendChild(div);

          // Recursive fetch
          const inner = div.querySelector(`#folder-${f.id}`);
          const res = await fetch(`${BACKEND_URL}/api/list/${f.id}`);
          const data = await res.json();
          if (data.files) {
            const subF = data.files.filter((x) =>
              x.mimeType.includes("folder"),
            );
            const subV = data.files.filter((x) => x.mimeType.includes("video"));
            await processNodes(subF, subV, inner, f.id);
          }
        }

        // Videos as "Messages"
        for (const v of videos) {
          flatPlaylist.push({ ...v, parentId });
          const div = document.createElement("div");
          div.id = `vid-${v.id}`;
          div.dataset.id = v.id;
          div.className = "tg-item file-btn";
          div.dataset.search = v.name.toLowerCase();
          div.innerHTML = `
                <div class="w-10 h-10 rounded-full bg-[#242f3d] flex items-center justify-center text-[#5288c1] shrink-0 icon-box">
                    <i class="fa-solid fa-play text-sm"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="text-sm text-white truncate leading-tight">${v.name.replace(/\.mp4/i, "")}</div>
                    <div class="text-xs text-muted mt-1 flex items-center gap-1">
                        <i class="fa-regular fa-clock text-[10px]"></i> Video
                    </div>
                </div>
            `;
          container.appendChild(div);
        }
      }

      function finalizeLoad(videoId) {
        document.querySelectorAll(".tg-item").forEach((el) => {
          if (el.classList.contains("file-btn")) {
            el.onclick = () => playVideoById(el.dataset.id);
          } else {
            el.onclick = () => {
              const fid = el.dataset.id;
              const content = document.getElementById(`folder-${fid}`);
              const chev = el.querySelector(".chevron");
              if (content.classList.contains("hidden")) {
                content.classList.remove("hidden");
                chev.style.transform = "rotate(180deg)";
              } else {
                content.classList.add("hidden");
                chev.style.transform = "rotate(0deg)";
              }
            };
          }
        });
        if (videoId) playVideoById(videoId);
      }

      function playVideoById(videoId) {
        const idx = flatPlaylist.findIndex((x) => x.id === videoId);
        if (idx === -1) return;
        currentIndex = idx;
        const video = flatPlaylist[idx];

        player.src({
          type: "video/mp4",
          src: `${BACKEND_URL}/stream/${video.id}`,
        });
        player.play().catch(() => {});

        // Update Text
        const title = video.name.replace(/\.mp4/i, "");
        document.getElementById("footer-title").innerText = title;
        if (document.getElementById("mobile-title"))
          document.getElementById("mobile-title").innerText = title;

        // Active State UI
        document.querySelectorAll(".tg-item").forEach((b) => {
          b.classList.remove("active");
          if (b.classList.contains("file-btn")) {
            b.querySelector(".icon-box").className =
              "w-10 h-10 rounded-full bg-[#242f3d] flex items-center justify-center text-[#5288c1] shrink-0 icon-box";
            b.querySelector(".icon-box").innerHTML =
              `<i class="fa-solid fa-play text-sm"></i>`;
          }
        });

        const activeBtn = document.getElementById(`vid-${videoId}`);
        if (activeBtn) {
          activeBtn.classList.add("active");
          activeBtn.scrollIntoView({ behavior: "smooth", block: "center" });
          // Change Icon to Pause/Wave
          activeBtn.querySelector(".icon-box").className =
            "w-10 h-10 rounded-full bg-[#5288c1] flex items-center justify-center text-white shrink-0 icon-box shadow-md";
          activeBtn.querySelector(".icon-box").innerHTML =
            `<i class="fa-solid fa-chart-simple"></i>`;

          // Open parent
          if (video.parentId) {
            const p = document.getElementById(`folder-${video.parentId}`);
            if (p) p.classList.remove("hidden");
          }
        }

        updateURL(currentCourse.id, videoId);
        localStorage.setItem(
          LAST_STATE_KEY,
          JSON.stringify({ courseId: currentCourse.id, videoId }),
        );
      }

      // Utils
      function addCourse() {
        const name = document.getElementById("new-course-name").value;
        const link = document.getElementById("new-course-link").value;
        const match = link.match(/(?:folders\/|id=)([\w-]+)/);
        if (name && match) {
          savedCourses.push({ name, id: match[1] });
          localStorage.setItem("drive_courses", JSON.stringify(savedCourses));
          renderLibrary();
          document.getElementById("new-course-name").value = "";
          document.getElementById("new-course-link").value = "";
        }
      }

      function deleteCourse(i) {
        if (confirm("Delete?")) {
          localStorage.removeItem(CACHE_PREFIX + savedCourses[i].id);
          savedCourses.splice(i, 1);
          localStorage.setItem("drive_courses", JSON.stringify(savedCourses));
          renderLibrary();
        }
      }

      function updateURL(c, v) {
        window.history.pushState({}, "", `?c=${c}&v=${v}`);
      }
      function toggleSidebar() {
        document.getElementById("sidebar").classList.toggle("open");
        document.getElementById("sidebar-overlay").classList.toggle("show");
      }
      function showLibrary() {
        document.getElementById("library-screen").classList.remove("hidden");
        renderLibrary();
      }
      function closeLibrary() {
        if (currentCourse)
          document.getElementById("library-screen").classList.add("hidden");
      }

      // Shared Link Logic (Skeleton)
      async function loadSharedCourse(cid, vid) {
        currentCourse = { id: cid, name: "Shared" };
        document.getElementById("library-screen").classList.add("hidden");
        const container = document.getElementById("playlist");
        container.innerHTML = "Loading...";
        await fetchCourseContent(cid, container);
        finalizeLoad(vid);
      }

      // Keyboard
      document.addEventListener("keydown", (e) => {
        if (e.target.tagName === "INPUT") return;
        const k = e.key.toLowerCase();
        if (e.code === "Space") {
          e.preventDefault();
          player.paused() ? player.play() : player.pause();
        }
        if (k === "f") {
          e.preventDefault();
          player.isFullscreen()
            ? player.exitFullscreen()
            : player.requestFullscreen();
        }
        if (k === "arrowright") {
          e.preventDefault();
          e.shiftKey
            ? playNext()
            : player.currentTime(player.currentTime() + 5);
        }
        if (k === "arrowleft") {
          e.preventDefault();
          player.currentTime(player.currentTime() - 5);
        }
      });

      // Controls
      const togglePlay = () =>
        player.paused() ? player.play() : player.pause();
      const playNext = () => {
        if (currentIndex + 1 < flatPlaylist.length)
          playVideoById(flatPlaylist[currentIndex + 1].id);
      };
      const playPrev = () => {
        if (currentIndex - 1 >= 0)
          playVideoById(flatPlaylist[currentIndex - 1].id);
      };
      const toggleFullscreen = () =>
        player.isFullscreen()
          ? player.exitFullscreen()
          : player.requestFullscreen();
      player.on(
        "play",
        () =>
          (document.getElementById("play-pause-icon").className =
            "fa-solid fa-pause"),
      );
      player.on(
        "pause",
        () =>
          (document.getElementById("play-pause-icon").className =
            "fa-solid fa-play"),
      );
      player.on("ended", playNext);

      // Search
      document.getElementById("search").addEventListener("input", (e) => {
        const v = e.target.value.toLowerCase();
        document.querySelectorAll(".file-btn").forEach((el) => {
          el.style.display = el.dataset.search.includes(v) ? "flex" : "none";
        });
      });

      init();
    </script>
  </body>
</html>
