<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <link rel="shortcut icon" href="assets/logo.png" type="image/x-icon" />
    <title>Drive Player</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <link rel="stylesheet" href="css/output.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />

    <style>
      /* --- TUMHARA ORIGINAL CSS --- */
      :root {
        --text-pri: #ffffff;
        --text-sec: #a1a1aa;
        --accent: #8b5cf6; /* Violet Accent */
        --accent-glow: rgba(139, 92, 246, 0.4);
      }

      * {
        box-sizing: border-box;
        outline: none;
        -webkit-tap-highlight-color: transparent;
        user-select: none;
      }
      .no-select {
        user-select: none;
      }
      body {
        -webkit-user-select: none; /* Safari */
        -ms-user-select: none; /* IE 10+ */
        user-select: none; /* Standard syntax */
        margin: 0;
        font-family: "Outfit", sans-serif;
        overflow: hidden;
        height: 100dvh;
        width: 100vw;
        color: var(--text-pri);
        background-color: #000;
        background-image:
          radial-gradient(at 0% 0%, hsla(253, 16%, 7%, 1) 0, transparent 50%),
          radial-gradient(at 50% 0%, hsla(225, 39%, 30%, 1) 0, transparent 50%),
          radial-gradient(at 100% 0%, hsla(339, 49%, 30%, 1) 0, transparent 50%);
        background-size: cover;
        display: flex;
      }

      /* --- GLASS UTILS --- */
      .glass-panel {
        background: rgba(10, 10, 10, 0.7);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-right: 1px solid rgba(255, 255, 255, 0.08);
      }
      .glass-card {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(10px);
      }

      /* Scrollbars */
      ::-webkit-scrollbar {
        width: 4px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      /* --- LAYOUT --- */
      .app-shell {
        display: flex;
        width: 100%;
        height: 100%;
        overflow: hidden;
        position: relative;
      }
      .app-shell.sidebar-right {
        flex-direction: row-reverse;
      }

      /* --- SIDEBAR --- */
      .sidebar {
        width: 340px;
        min-width: 260px;
        max-width: 500px;
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
        z-index: 20;
      }

      .resizer {
        width: 2px;
        background: rgba(255, 255, 255, 0.05);
        cursor: col-resize;
        z-index: 50;
        flex-shrink: 0;
        transition: 0.2s;
      }
      .resizer:hover {
        background: var(--accent);
      }

      /* --- LIST ITEMS --- */
      .folder-btn {
        padding: 12px 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid rgba(255, 255, 255, 0.03);
        color: var(--text-sec);
        cursor: pointer;
        font-size: 14px;
        transition: 0.2s;
      }
      .folder-btn:hover {
        background: rgba(255, 255, 255, 0.05);
        color: #fff;
      }

      .folder-content {
        display: none;
        background: rgba(0, 0, 0, 0.2);
      }
      .folder-content.open {
        display: block;
      }

      .file-btn {
        padding: 10px 16px 10px 24px;
        display: flex;
        align-items: center;
        gap: 10px;
        color: #999;
        font-size: 13px;
        cursor: pointer;
        transition: 0.2s;
        border-left: 2px solid transparent;
      }
      .file-btn:hover {
        background: rgba(255, 255, 255, 0.03);
        color: #fff;
      }
      .file-btn.active {
        background: linear-gradient(
          90deg,
          rgba(139, 92, 246, 0.15),
          transparent
        );
        border-left-color: var(--accent);
        color: #fff;
        font-weight: 500;
      }
      .file-btn.active i {
        color: var(--accent);
      }

      /* Nested Indentation */
      .indent-level-1 .file-btn {
        padding-left: 32px;
      }
      .indent-level-1 .folder-btn {
        padding-left: 24px;
      }

      /* --- MAIN CONTENT --- */
      .main-content {
        flex: 1;
        min-width: 0;
        display: flex;
        flex-direction: column;
        position: relative;
        background: #000;
      }

      /* --- LIBRARY SCREEN --- */
      #library-screen {
        background: rgba(5, 5, 5, 0.95);
        backdrop-filter: blur(30px);
      }
      .course-card {
        transition:
          transform 0.3s,
          border-color 0.3s;
      }
      .course-card:hover {
        transform: translateY(-4px);
        border-color: var(--accent);
        box-shadow: 0 10px 30px -10px var(--accent-glow);
      }

      /* --- TOAST --- */
      #toast-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 12px;
        pointer-events: none;
      }
      .toast {
        pointer-events: auto;
        transform: translateX(130%);
        transition: transform 0.4s cubic-bezier(0.17, 0.84, 0.44, 1);
      }
      .toast.show {
        transform: translateX(0);
      }
      .toast-card {
        background: rgba(15, 15, 20, 0.9);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-left: 4px solid var(--accent);
        border-radius: 10px;
        padding: 12px 16px;
        display: flex;
        align-items: center;
        min-width: 280px;
        max-width: 350px;
        box-shadow:
          0 10px 25px rgba(0, 0, 0, 0.4),
          0 0 15px var(--accent-glow);
      }
      .status-icon {
        color: var(--accent);
        padding: 6px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .toast-message {
        margin: 0 12px;
        color: #e4e4e7;
        font-size: 14px;
        font-weight: 500;
        flex-grow: 1;
      }

      .close-btn {
        background: transparent;
        border: none;
        color: #71717a;
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        transition: 0.2s;
      }

      .close-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        color: white;
      }

      /* Animation */
      .wave-anim {
        display: flex;
        gap: 2px;
        height: 12px;
        align-items: flex-end;
      }
      .bar {
        width: 2px;
        background: var(--accent);
        animation: wave 1s infinite;
        border-radius: 2px;
      }
      .bar:nth-child(2) {
        animation-delay: 0.1s;
      }
      .bar:nth-child(3) {
        animation-delay: 0.2s;
      }
      @keyframes wave {
        0%,
        100% {
          height: 30%;
        }
        50% {
          height: 100%;
        }
      }

      /* Mobile */
      @media (max-width: 768px) {
        .app-shell {
          flex-direction: column-reverse !important;
        }
        .main-content {
          height: 35vh !important;
          flex: none;
          width: 100%;
          border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .sidebar {
          width: 100% !important;
          height: 65vh !important;
          border-right: none;
          flex: none;
        }
        .resizer,
        header {
          display: none;
        }
        #floating-settings {
          top: 10px;
          right: 10px;
        }
      }
    </style>
  </head>
  <body>
    <div
      id="floating-settings"
      class="flex w-full justify-end absolute top-5 right-6 z-100 items-start"
    >
      <button
        onclick="shareCurrentCourse()"
        class="w-9 h-9 rounded-full glass-card flex items-center justify-center text-gray-400 hover:text-white transition hover:bg-white/10"
        title="Share Course Link"
      >
        <i class="fa-solid fa-share-nodes"></i>
      </button>
      <button
        onclick="openSettings()"
        class="w-9 h-9 rounded-full glass-card flex items-center justify-center text-gray-400 hover:text-white transition hover:bg-white/10"
      >
        <i class="fa-solid fa-gear"></i>
      </button>
    </div>

    <div id="toast-container"></div>

    <div
      id="library-screen"
      class="fixed inset-0 z-[1000] flex flex-col items-center justify-center p-6 none"
    >
      <button
        onclick="closeLibrary()"
        id="lib-close-btn"
        class="absolute top-6 left-6 w-9 h-9 rounded-full glass-card text-gray-400 hover:text-white flex items-center justify-center none"
      >
        <i class="fa-solid fa-arrow-left"></i>
      </button>

      <div class="w-full max-w-5xl h-full flex flex-col">
        <div
          class="flex flex-col md:flex-row justify-between items-end mb-10 mt-12 shrink-0 gap-6"
        >
          <div class="text-center">
            <h1 class="text-4xl font-light text-white tracking-tight mb-2"></h1>
            <p class="text-gray-400 text-sm font-light"></p>
          </div>
          <div class="flex glass-card p-1 rounded-xl w-full md:w-auto">
            <input
              type="text"
              id="new-course-name"
              placeholder="Title"
              class="bg-transparent text-white px-4 py-2 text-sm w-32 outline-none border-r border-white/10"
            />
            <input
              type="text"
              id="new-course-link"
              placeholder="Paste Drive Link..."
              class="bg-transparent text-white px-4 py-2 text-sm w-full md:w-64 outline-none"
            />
            <button
              onclick="addCourse()"
              class="bg-violet-600 hover:bg-violet-500 text-white px-5 rounded-lg text-sm font-medium transition shadow-lg shadow-violet-900/40"
            >
              Add
            </button>
          </div>
        </div>
        <div
          id="course-list"
          class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 w-full overflow-y-auto custom-scroll pb-20 pt-2 px-2"
        ></div>
      </div>
    </div>

    <div
      id="settings-modal"
      class="fixed inset-0 z-[2000] hidden items-center justify-center bg-black/60 backdrop-blur-sm"
    >
      <div
        class="glass-card p-6 rounded-2xl w-[90%] max-w-sm"
        style="background: #111"
      >
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-white font-medium">Preferences</h3>
          <button
            onclick="closeSettings()"
            class="text-gray-400 hover:text-white"
          >
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
        <div class="space-y-6">
          <div>
            <label
              class="text-gray-500 text-xs font-bold uppercase mb-2 block tracking-wider"
              >Sidebar</label
            >
            <div class="grid grid-cols-2 gap-2 bg-white/5 p-1 rounded-xl">
              <button
                onclick="setSidebar('left')"
                id="btn-left"
                class="py-2 text-xs rounded-lg transition-all"
              >
                Left
              </button>
              <button
                onclick="setSidebar('right')"
                id="btn-right"
                class="py-2 text-xs rounded-lg transition-all"
              >
                Right
              </button>
            </div>
          </div>
          <div class="pt-4 border-t border-white/10">
            <button
              onclick="
                showLibrary();
                closeSettings();
              "
              class="w-full py-3 text-sm text-white glass-card hover:bg-white/10 rounded-xl transition"
            >
              Switch Course
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="app-shell" id="app-shell">
      <aside class="sidebar glass-panel" id="sidebar">
        <div class="p-4 border-b border-white/5">
          <div
            class="flex items-center gap-3 mb-4 opacity-90 cursor-pointer hover:opacity-100"
            onclick="showLibrary()"
          >
            <div class="w-8 h-8 flex items-center justify-center">
              <img src="assets/logo.png" alt="" />
            </div>
            <div class="overflow-hidden">
              <span
                id="header-course-name"
                class="text-sm font-medium truncate text-white block"
                >Select...</span
              >
            </div>
          </div>
          <div class="relative group">
            <i
              class="fa-solid fa-magnifying-glass absolute left-3 top-2.5 text-gray-500 text-xs"
            ></i>
            <input
              type="text"
              id="search"
              placeholder="Search modules..."
              class="w-full bg-white/5 text-white pl-9 p-2 rounded-lg text-xs outline-none focus:bg-white/10 transition border border-transparent focus:border-violet-500/30"
            />
          </div>
        </div>
        <div
          id="playlist"
          class="flex-1 overflow-y-auto custom-scroll pb-10"
        ></div>
      </aside>

      <div class="resizer" id="resizer"></div>

      <main class="main-content">
        <div
          class="flex-1 relative bg-black w-full h-full flex items-center justify-center overflow-hidden"
        >
          <div
            class="absolute inset-0 bg-gradient-to-b from-violet-900/5 to-black pointer-events-none"
          ></div>
          <video
            id="my-video"
            class="video-js vjs-fill vjs-big-play-centered relative z-10"
            controls
            preload="auto"
            playsinline
          >
            <p class="vjs-no-js">Enable JS.</p>
          </video>
        </div>

        <div
          class="h-[60px] bg-[#050505] border-t border-white/5 flex items-center justify-between px-6 shrink-0 none md:flex"
        >
          <div class="flex flex-col w-2/3">
            <span
              class="text-[10px] text-violet-500 font-bold tracking-widest uppercase mb-0.5"
              >NOW PLAYING</span
            >
            <span
              id="video-title"
              class="truncate text-sm text-gray-300 font-medium"
              >No video selected</span
            >
          </div>
          <div class="flex gap-2">
            <button
              onclick="shareCurrentCourse()"
              class="w-9 h-9 rounded-full glass-card hover:bg-white/10 flex items-center justify-center text-gray-400 hover:text-white transition"
              title="Share Link"
            >
              <i class="fa-solid fa-link"></i>
            </button>
            <div class="w-[1px] h-6 bg-white/10 mx-2 self-center"></div>
            <button
              onclick="playPrev()"
              class="w-9 h-9 rounded-full glass-card hover:bg-white/10 flex items-center justify-center text-gray-400 hover:text-white transition"
            >
              <i class="fa-solid fa-backward-step"></i>
            </button>
            <button
              onclick="playNext()"
              class="w-9 h-9 rounded-full glass-card hover:bg-white/10 flex items-center justify-center text-gray-400 hover:text-white transition"
            >
              <i class="fa-solid fa-forward-step"></i>
            </button>
          </div>
        </div>
      </main>
    </div>

    <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
    <script>
      // --- CONFIGURATION ---
      // IMPORTANT: Ab API Key ki zaroorat nahi hai. Sab kuch Backend handle karega.
      const BACKEND_URL = "https://drive-2ipw.onrender.com";

      const CACHE_PREFIX = "drive_content_v5_"; // Version Bumped to Clear Old Cache
      const LAST_STATE_KEY = "drive_last_state_v5";

      // STATE
      let savedCourses = JSON.parse(
        localStorage.getItem("drive_courses") || "[]",
      );
      let userSettings = JSON.parse(
        localStorage.getItem("drive_settings") || '{"sidebar": "left"}',
      );
      let currentCourse = null;
      let flatPlaylist = [];
      let currentIndex = -1;

      // INIT PLAYER
      const player = videojs("my-video", {
        fill: true,
        responsive: true,
        playbackRates: [0.5, 1, 1.1, 1.2, 1.3, 1.4, 2],
        html5: { vhs: { overrideNative: true }, nativeCaptions: false },
        userActions: { hotkeys: false },
        controlBar: { volumePanel: { inline: false }, subsCapsButton: true },
        html5: {
          nativeTextTracks: true,
        },
      });

      // --- INITIALIZATION ---
      async function init() {
        setSidebar(userSettings.sidebar);

        // 1. Check for URL Params (Shared Link Logic)
        const urlParams = new URLSearchParams(window.location.search);
        const sharedCourseId = urlParams.get("c");
        const sharedVideoId = urlParams.get("v");

        if (sharedCourseId) {
          await loadSharedCourse(sharedCourseId, sharedVideoId);
        } else {
          initLibrary();
          const lastState = JSON.parse(localStorage.getItem(LAST_STATE_KEY));
          if (lastState && lastState.courseId) {
            const course = savedCourses.find(
              (c) => c.id === lastState.courseId,
            );
            if (course) {
              loadCourse(course, lastState.videoId);
            } else showLibrary();
          } else showLibrary();
        }
      }

      // --- CORE LOGIC: Loading ---

      function loadCourseByIndex(index) {
        loadCourse(savedCourses[index]);
      }

      async function loadCourse(courseObj, autoPlayVideoId = null) {
        currentCourse = courseObj;

        // UI Updates
        document.getElementById("library-screen").classList.add("none");
        document.getElementById("header-course-name").innerText =
          currentCourse.name;
        document.getElementById("lib-close-btn").style.display = "flex";

        const container = document.getElementById("playlist");
        const cached = localStorage.getItem(CACHE_PREFIX + currentCourse.id);

        if (cached) {
          const data = JSON.parse(cached);
          flatPlaylist = data.flatPlaylist;
          container.innerHTML = data.htmlStr;
          finalizeLoad(autoPlayVideoId);
        } else {
          container.innerHTML = `<div class="p-8 text-center text-gray-500 text-xs animate-pulse">Syncing Cloud Structure from Server...</div>`;
          flatPlaylist = [];
          await fetchCourseContent(currentCourse.id, container);
          finalizeLoad(autoPlayVideoId);
        }

        updateURL(currentCourse.id, autoPlayVideoId);
      }

      // --- UPDATED LOGIC: No API Key, Use Backend ---
      async function loadSharedCourse(courseId, videoId) {
        document.getElementById("library-screen").classList.add("none");
        const container = document.getElementById("playlist");
        container.innerHTML = `<div class="p-8 text-center text-gray-500 text-xs animate-pulse">Resolving Shared Link...</div>`;

        try {
          // New: Fetch Name from Backend
          const res = await fetch(`${BACKEND_URL}/api/meta/${courseId}`);
          const meta = await res.json();

          const ghostCourse = {
            id: courseId,
            name: meta.name || "Shared Course",
          };
          currentCourse = ghostCourse;

          document.getElementById("header-course-name").innerText =
            ghostCourse.name;
          document.getElementById("lib-close-btn").style.display = "flex";

          const cached = localStorage.getItem(CACHE_PREFIX + courseId);
          if (cached) {
            const data = JSON.parse(cached);
            flatPlaylist = data.flatPlaylist;
            container.innerHTML = data.htmlStr;
          } else {
            flatPlaylist = [];
            await fetchCourseContent(courseId, container);
          }
          finalizeLoad(videoId);
        } catch (e) {
          showToast("Invalid Link or Permission Denied");
          showLibrary();
        }
      }

      function finalizeLoad(autoPlayVideoId) {
        // Re-attach listeners because innerHTML replaced them
        document
          .querySelectorAll(".folder-btn")
          .forEach((btn) => (btn.onclick = () => toggleFolder(btn.dataset.id)));
        document
          .querySelectorAll(".file-btn")
          .forEach(
            (btn) => (btn.onclick = () => playVideoById(btn.dataset.id)),
          );

        if (autoPlayVideoId) {
          playVideoById(autoPlayVideoId);
        }
      }

      // --- UPDATED FETCH LOGIC (BACKEND PROXY) ---
      async function fetchCourseContent(rootId, container) {
        // No Google API Call here. We call our Backend.
        const url = `${BACKEND_URL}/api/list/${rootId}`;
        try {
          const res = await fetch(url);
          const data = await res.json(); // Data structure is { files: [...] }

          if (!data.files) return;
          container.innerHTML = "";

          const folders = data.files.filter((f) =>
            f.mimeType.includes("folder"),
          );
          const videos = data.files.filter((f) => f.mimeType.includes("video"));

          await processNodes(folders, videos, container, rootId);

          localStorage.setItem(
            CACHE_PREFIX + rootId,
            JSON.stringify({
              flatPlaylist: flatPlaylist,
              htmlStr: container.innerHTML,
            }),
          );
        } catch (e) {
          console.error(e);
          container.innerHTML = `<div class="text-red-500 p-4 text-sm">Server Error. Check Backend.</div>`;
        }
      }

      async function processNodes(folders, videos, container, parentId) {
        for (const f of folders) {
          const div = document.createElement("div");
          div.innerHTML = `
                  <div id="btn-${f.id}" class="folder-btn group" data-id="${f.id}">
                      <div class="flex items-center gap-3 truncate">
                          <i class="fa-regular fa-folder text-violet-400 opacity-60 group-hover:opacity-100 transition"></i>
                          <span class="truncate transition-colors">${f.name}</span>
                      </div>
                      <i class="fa-solid fa-chevron-down text-[10px] chevron transition-transform duration-200 opacity-40"></i>
                  </div>
                  <div id="folder-${f.id}" class="folder-content pl-2"></div> `;
          container.appendChild(div);

          const innerContainer = div.querySelector(`#folder-${f.id}`);
          innerContainer.classList.add("indent-level-1");

          // Recursion: Fetch subfolders using Backend
          const url = `${BACKEND_URL}/api/list/${f.id}`;
          const res = await fetch(url);
          const data = await res.json();

          if (data.files) {
            const subFolders = data.files.filter((x) =>
              x.mimeType.includes("folder"),
            );
            const subVideos = data.files.filter((x) =>
              x.mimeType.includes("video"),
            );
            await processNodes(subFolders, subVideos, innerContainer, f.id);
          }
        }

        for (const v of videos) {
          flatPlaylist.push({ ...v, parentId: parentId });
          const div = document.createElement("div");
          div.id = `vid-${v.id}`;
          div.className = "file-btn group";
          div.dataset.id = v.id;
          div.dataset.search = v.name.toLowerCase();
          div.innerHTML = `<i class="fa-regular fa-circle-play text-xs opacity-40 group-hover:text-white transition icon-box shrink-0"></i><span class="truncate">${v.name.replace(/\.mp4/i, "")}</span>`;
          container.appendChild(div);
        }
      }

      // --- PLAYBACK ---
      function playVideoById(videoId) {
        const videoIndex = flatPlaylist.findIndex((v) => v.id === videoId);
        if (videoIndex === -1) return;
        const video = flatPlaylist[videoIndex];
        currentIndex = videoIndex;

        // Backend Video Stream
        player.src({
          type: "video/mp4",
          src: `${BACKEND_URL}/stream/${video.id}`,
        });
        player.play().catch(() => {});
        document.getElementById("video-title").innerText = video.name.replace(
          /\.mp4/i,
          "",
        );

        // UI Active State
        document.querySelectorAll(".file-btn").forEach((b) => {
          b.classList.remove("active");
          b.querySelector(".icon-box").className =
            "fa-regular fa-circle-play text-xs opacity-40 group-hover:text-white transition icon-box shrink-0";
          b.querySelector(".icon-box").innerHTML = "";
        });

        const activeBtn = document.querySelector(
          `.file-btn[data-id="${videoId}"]`,
        );
        if (activeBtn) {
          activeBtn.classList.add("active");
          const iconBox = activeBtn.querySelector(".icon-box");
          iconBox.className = "icon-box shrink-0";
          iconBox.innerHTML = `<div class="wave-anim"><div class="bar"></div><div class="bar"></div><div class="bar"></div></div>`;

          if (video.parentId) {
            let p = document.getElementById(`folder-${video.parentId}`);
            if (p) {
              p.classList.add("open");
              document
                .getElementById(`btn-${video.parentId}`)
                .querySelector(".chevron").style.transform = "rotate(180deg)";
            }
          }
        }

        updateURL(currentCourse.id, videoId);
        localStorage.setItem(
          LAST_STATE_KEY,
          JSON.stringify({ courseId: currentCourse.id, videoId: video.id }),
        );
      }

      function updateURL(courseId, videoId) {
        if (!courseId) return;
        let newUrl = `?c=${courseId}`;
        if (videoId) newUrl += `&v=${videoId}`;
        window.history.pushState({ path: newUrl }, "", newUrl);
      }

      function shareCurrentCourse() {
        if (!currentCourse) return;
        const url = window.location.href;
        navigator.clipboard.writeText(url).then(() => {
          showToast("Link Copied! Share it with anyone.");
        });
      }

      function toggleFolder(id) {
        const el = document.getElementById(`folder-${id}`);
        const btn = document.getElementById(`btn-${id}`);
        const chevron = btn.querySelector(".chevron");
        if (el.classList.contains("open")) {
          el.classList.remove("open");
          chevron.style.transform = "rotate(0deg)";
        } else {
          el.classList.add("open");
          chevron.style.transform = "rotate(180deg)";
        }
      }

      const playNext = () => {
        if (currentIndex + 1 < flatPlaylist.length)
          playVideoById(flatPlaylist[currentIndex + 1].id);
      };
      const playPrev = () => {
        if (currentIndex - 1 >= 0)
          playVideoById(flatPlaylist[currentIndex - 1].id);
      };

      player.on("ended", () => {
        showToast("Playing next...");
        playNext();
      });

      // --- LIBRARY & UTILS ---
      function initLibrary() {
        const list = document.getElementById("course-list");
        list.innerHTML = "";
        if (savedCourses.length === 0)
          list.innerHTML = `<div class="col-span-full text-center text-gray-500 py-20 font-light">Add a Google Drive link to begin.</div>`;
        savedCourses.forEach((c, i) => {
          const div = document.createElement("div");
          div.className =
            "course-card glass-card p-6 h-[180px] flex flex-col justify-between rounded-2xl cursor-pointer group hover:bg-white/5";
          div.onclick = (e) => {
            if (!e.target.closest("button")) loadCourseByIndex(i);
          };
          div.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="w-12 h-12 rounded-2xl bg-white/5 border border-white/10 flex items-center justify-center text-white font-bold text-xl shadow-lg group-hover:bg-violet-600 transition-colors">${c.name[0].toUpperCase()}</div>
                    <button onclick="deleteCourse(${i})" class="text-gray-500 hover:text-red-400 p-2 opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-trash-can"></i></button>
                </div>
                <div><h3 class="text-lg font-medium text-white leading-tight line-clamp-2">${c.name}</h3><p class="text-xs text-gray-500 font-mono mt-2 opacity-60">ID: ${c.id.slice(0, 6)}</p></div>
              `;
          list.appendChild(div);
        });
      }

      function addCourse() {
        const name = document.getElementById("new-course-name").value;
        const link = document.getElementById("new-course-link").value;
        const match = link.match(/(?:folders\/|id=)([\w-]+)/);
        if (name && match) {
          savedCourses.push({ name: name, id: match[1] });
          localStorage.setItem("drive_courses", JSON.stringify(savedCourses));
          initLibrary();
        } else {
          alert("Invalid Link");
        }
      }
      function deleteCourse(i) {
        if (confirm("Delete?")) {
          localStorage.removeItem(CACHE_PREFIX + savedCourses[i].id);
          savedCourses.splice(i, 1);
          localStorage.setItem("drive_courses", JSON.stringify(savedCourses));
          initLibrary();
        }
      }

      // UI HELPERS
      function showLibrary() {
        window.history.pushState({}, "", window.location.pathname);
        document.getElementById("library-screen").classList.remove("none");
        initLibrary();
      }
      function closeLibrary() {
        document.getElementById("library-screen").classList.add("none");
      }
      function openSettings() {
        document.getElementById("settings-modal").style.display = "flex";
      }
      function closeSettings() {
        document.getElementById("settings-modal").style.display = "none";
      }

      const resizer = document.getElementById("resizer");
      const sidebar = document.getElementById("sidebar");
      let isResizing = false;
      resizer.addEventListener("mousedown", () => {
        isResizing = true;
        document.body.style.cursor = "col-resize";
      });
      document.addEventListener("mouseup", () => {
        isResizing = false;
        document.body.style.cursor = "";
      });
      document.addEventListener("mousemove", (e) => {
        if (!isResizing) return;
        const w = document
          .getElementById("app-shell")
          .classList.contains("sidebar-right")
          ? window.innerWidth - e.clientX
          : e.clientX;
        if (w > 200 && w < 600) sidebar.style.width = w + "px";
      });
      function setSidebar(pos) {
        const shell = document.getElementById("app-shell");
        if (pos === "right") shell.classList.add("sidebar-right");
        else shell.classList.remove("sidebar-right");
        userSettings.sidebar = pos;
        localStorage.setItem("drive_settings", JSON.stringify(userSettings));
      }

      function showToast(msg) {
        const container = document.getElementById("toast-container");
        const toast = document.createElement("div");
        toast.className = "toast";
        toast.innerHTML = `
        <div class="toast-card">
            <div class="status-icon">
                <i class="fa-solid fa-check"></i>
            </div>
            <div class="toast-message">${msg}</div>
            <button type="button" class="close-btn" onclick="this.closest('.toast').remove()">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
    `;
        container.appendChild(toast);
        requestAnimationFrame(() => toast.classList.add("show"));
        setTimeout(() => {
          toast.classList.remove("show");
          setTimeout(() => toast.remove(), 500);
        }, 3000);
      }

      document.getElementById("search").addEventListener("input", (e) => {
        const v = e.target.value.toLowerCase();
        document
          .querySelectorAll(".file-btn")
          .forEach(
            (b) =>
              (b.style.display = b.dataset.search.includes(v)
                ? "flex"
                : "none"),
          );
      });

      document.addEventListener("keydown", (e) => {
        if (e.target.tagName === "INPUT") return;
        const k = e.key.toLowerCase();
        const isCmd = e.metaKey || e.ctrlKey;
        if (e.code === "Space") {
          e.preventDefault();
          player.paused() ? player.play() : player.pause();
        }
        if (k === "f") {
          e.preventDefault();
          player.isFullscreen()
            ? player.exitFullscreen()
            : player.requestFullscreen();
        }
        if (k === "arrowright") {
          e.preventDefault();
          if (isCmd) playNext();
          else player.currentTime(player.currentTime() + 1.5);
        }
        if (k === "arrowleft") {
          e.preventDefault();
          if (isCmd) playPrev();
          else player.currentTime(player.currentTime() - 1.5);
        }
      });

      init();
    </script>
  </body>
</html>
